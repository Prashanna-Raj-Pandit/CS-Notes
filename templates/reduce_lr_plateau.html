{% extends "base.html" %}

{% block title %}{{ subtopic.title }} - Study Hub{% endblock %}

{% block content %}
<div class="content-header">
    <div class="container">
        <div class="breadcrumb">
            <a href="/">Home</a> /
            <a href="/topic/{{ topic_id }}">{{ topic.name }}</a> /
            <span>{{ subtopic.title }}</span>
        </div>
        <h1 class="content-title">{{ subtopic.title }}</h1>
    </div>
</div>

<div class="container">
    <div class="content-body">
        <style>
            .plateau-container {
                background: white;
                border-radius: 15px;
                padding: 40px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            }
            .section {
                margin: 40px 0;
            }
            .section h2 {
                color: #764ba2;
                border-bottom: 3px solid #667eea;
                padding-bottom: 10px;
                margin-bottom: 20px;
            }
            .explanation {
                background: #e7f3ff;
                padding: 20px;
                border-radius: 10px;
                margin: 20px 0;
                border-left: 5px solid #667eea;
            }
            .chart-container {
                position: relative;
                height: 400px;
                margin: 30px 0;
                background: #f8f9fa;
                padding: 20px;
                border-radius: 10px;
            }
            .comparison {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
                margin: 20px 0;
            }
            .comparison-box {
                padding: 20px;
                border-radius: 10px;
                box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            }
            .bad {
                background: #ffe7e7;
                border-left: 5px solid #ff4444;
            }
            .good {
                background: #e7ffe7;
                border-left: 5px solid #44ff44;
            }
            .code-block {
                background: #2d2d2d;
                color: #f8f8f2;
                padding: 20px;
                border-radius: 10px;
                font-family: 'Courier New', monospace;
                overflow-x: auto;
                margin: 20px 0;
            }
            .highlight {
                background: #ffeb3b;
                padding: 2px 5px;
                border-radius: 3px;
                font-weight: bold;
                color: #2d3748;
            }
            table {
                width: 100%;
                border-collapse: collapse;
                margin: 20px 0;
            }
            th, td {
                padding: 12px;
                text-align: left;
                border-bottom: 1px solid #ddd;
            }
            th {
                background: #667eea;
                color: white;
            }
            tr:hover {
                background: #f5f5f5;
            }
            .annotation {
                background: #fff3cd;
                border-left: 4px solid #ffc107;
                padding: 15px;
                margin: 15px 0;
                border-radius: 5px;
            }
            @media (max-width: 768px) {
                .comparison {
                    grid-template-columns: 1fr;
                }
            }
        </style>

        <div class="plateau-container">
            <h1 style="color: #667eea; text-align: center; margin-bottom: 30px;">üèîÔ∏è Understanding Plateaus & ReduceLROnPlateau</h1>

            <div class="section">
                <h2>1. What is a Plateau?</h2>
                <div class="explanation">
                    <strong>Plateau:</strong> When your model's loss (or accuracy) <span class="highlight">stops improving</span> and stays flat for several epochs.
                </div>

                <div class="chart-container">
                    <canvas id="plateauChart"></canvas>
                </div>

                <div class="annotation">
                    <strong>Notice:</strong> Epochs 10-25 show a plateau - the loss barely changes! The model is "stuck" at 0.3 loss.
                </div>
            </div>

            <div class="section">
                <h2>2. Why Does a Plateau Happen?</h2>
                <div class="comparison">
                    <div class="comparison-box bad">
                        <h3>‚ùå Problem: Learning Rate Too Large</h3>
                        <p>Steps are too big - the model "bounces around" the optimal point without settling in.</p>
                        <p><strong>Analogy:</strong> Like trying to walk down stairs by jumping 5 steps at a time - you'll miss the bottom!</p>
                    </div>
                    <div class="comparison-box bad">
                        <h3>‚ùå Problem: Learning Rate Too Small</h3>
                        <p>Steps are too tiny - progress is extremely slow, appears stuck.</p>
                        <p><strong>Analogy:</strong> Like walking down stairs taking baby steps - it takes forever!</p>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>3. What is ReduceLROnPlateau?</h2>
                <div class="explanation">
                    A <strong>callback</strong> that automatically <span class="highlight">reduces the learning rate</span> when training plateaus.
                    <br><br>
                    <strong>The Logic:</strong> "If the model hasn't improved in a while, let's try smaller steps!"
                </div>

                <div class="chart-container">
                    <canvas id="reduceLRChart"></canvas>
                </div>

                <div class="annotation">
                    <strong>See the magic:</strong> When plateau detected at epoch 10, LR reduced from 0.01 to 0.005. Loss starts improving again! This happens twice more.
                </div>
            </div>

            <div class="section">
                <h2>4. How ReduceLROnPlateau Works</h2>

                <table>
                    <thead>
                        <tr>
                            <th>Epoch</th>
                            <th>Val Loss</th>
                            <th>Best So Far</th>
                            <th>Patience Counter</th>
                            <th>Action</th>
                            <th>Learning Rate</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td>0.500</td>
                            <td>0.500</td>
                            <td>0</td>
                            <td>‚úÖ New best!</td>
                            <td>0.01</td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td>0.450</td>
                            <td>0.450</td>
                            <td>0</td>
                            <td>‚úÖ New best!</td>
                            <td>0.01</td>
                        </tr>
                        <tr>
                            <td>3</td>
                            <td>0.455</td>
                            <td>0.450</td>
                            <td>1</td>
                            <td>‚ö†Ô∏è No improvement</td>
                            <td>0.01</td>
                        </tr>
                        <tr>
                            <td>4</td>
                            <td>0.452</td>
                            <td>0.450</td>
                            <td>2</td>
                            <td>‚ö†Ô∏è No improvement</td>
                            <td>0.01</td>
                        </tr>
                        <tr>
                            <td>5</td>
                            <td>0.451</td>
                            <td>0.450</td>
                            <td>3</td>
                            <td>‚ö†Ô∏è No improvement</td>
                            <td>0.01</td>
                        </tr>
                        <tr style="background: #ffe7e7;">
                            <td>6</td>
                            <td>0.450</td>
                            <td>0.450</td>
                            <td>0 (reset)</td>
                            <td>üîª REDUCE LR! (patience=3 reached)</td>
                            <td>0.005</td>
                        </tr>
                        <tr>
                            <td>7</td>
                            <td>0.430</td>
                            <td>0.430</td>
                            <td>0</td>
                            <td>‚úÖ New best! (smaller LR helps)</td>
                            <td>0.005</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="section">
                <h2>5. Code Example</h2>
                <div class="code-block">
<pre>from tensorflow.keras.callbacks import ReduceLROnPlateau

reduce_lr = ReduceLROnPlateau(
    monitor='val_loss',      # Watch validation loss
    factor=0.5,              # Reduce LR by half (new_lr = old_lr * 0.5)
    patience=10,             # Wait 10 epochs without improvement
    min_lr=1e-6,             # Don't go below 0.000001
    verbose=1                # Print messages
)

model.fit(
    X_train, y_train,
    validation_data=(X_val, y_val),
    epochs=100,
    callbacks=[reduce_lr]
)</pre>
                </div>
            </div>

            <div class="section">
                <h2>6. Key Parameters Explained</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Parameter</th>
                            <th>What It Does</th>
                            <th>Example</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>monitor</strong></td>
                            <td>Which metric to watch</td>
                            <td>'val_loss', 'val_accuracy'</td>
                        </tr>
                        <tr>
                            <td><strong>patience</strong></td>
                            <td>How many epochs to wait before reducing</td>
                            <td>10 = wait 10 epochs with no improvement</td>
                        </tr>
                        <tr>
                            <td><strong>factor</strong></td>
                            <td>How much to reduce LR</td>
                            <td>0.5 = cut in half, 0.2 = reduce to 20%</td>
                        </tr>
                        <tr>
                            <td><strong>min_lr</strong></td>
                            <td>Minimum learning rate (stop reducing here)</td>
                            <td>1e-6 = don't go below 0.000001</td>
                        </tr>
                        <tr>
                            <td><strong>verbose</strong></td>
                            <td>Print messages when LR is reduced</td>
                            <td>1 = yes, 0 = no</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="section">
                <h2>7. Real Example Output</h2>
                <div class="code-block">
<pre>Epoch 1/100
loss: 0.6500 - val_loss: 0.6200

Epoch 10/100
loss: 0.3200 - val_loss: 0.3500

Epoch 20/100
loss: 0.3150 - val_loss: 0.3480
<span style="color: #ffeb3b;">Epoch 21: ReduceLROnPlateau reducing learning rate to 0.0005.</span>

Epoch 25/100
loss: 0.2800 - val_loss: 0.3100  ‚Üê Loss improving again!

Epoch 35/100
loss: 0.2750 - val_loss: 0.3050
<span style="color: #ffeb3b;">Epoch 36: ReduceLROnPlateau reducing learning rate to 0.00025.</span></pre>
                </div>
            </div>

            <div class="section">
                <h2>8. When to Use ReduceLROnPlateau?</h2>
                <div class="comparison">
                    <div class="comparison-box good">
                        <h3>‚úÖ Use When:</h3>
                        <ul>
                            <li>You're not sure what LR to use</li>
                            <li>Training long-term (100+ epochs)</li>
                            <li>You want automatic LR adjustment</li>
                            <li>Working with small datasets</li>
                        </ul>
                    </div>
                    <div class="comparison-box bad">
                        <h3>‚ùå Don't Use When:</h3>
                        <ul>
                            <li>Doing LR finder experiment</li>
                            <li>Using LearningRateScheduler</li>
                            <li>Training very few epochs</li>
                            <li>You need fixed LR for comparison</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>9. Summary</h2>
                <div class="explanation">
                    <h3>üéØ The Big Picture:</h3>
                    <ol>
                        <li><strong>Plateau</strong> = Model stops improving (stuck)</li>
                        <li><strong>ReduceLROnPlateau</strong> = Automatically makes learning rate smaller when stuck</li>
                        <li><strong>Why it works</strong> = Smaller steps help fine-tune and escape local minimums</li>
                        <li><strong>Result</strong> = Better final performance without manual tuning!</li>
                    </ol>
                    <br>
                    <p style="text-align: center; font-size: 1.2em; margin-top: 20px;">
                        <strong>Think of it as:</strong> Your model's GPS saying "You're close to the destination, take smaller steps now!"
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
    // Plateau Chart
    const ctx1 = document.getElementById('plateauChart').getContext('2d');
    new Chart(ctx1, {
        type: 'line',
        data: {
            labels: Array.from({length: 40}, (_, i) => i + 1),
            datasets: [{
                label: 'Training Loss',
                data: [
                    0.7, 0.65, 0.58, 0.52, 0.45, 0.40, 0.37, 0.34, 0.32, 0.30,
                    0.30, 0.30, 0.30, 0.30, 0.30, 0.30, 0.30, 0.30, 0.30, 0.30,
                    0.30, 0.30, 0.30, 0.30, 0.30, 0.29, 0.29, 0.29, 0.28, 0.28,
                    0.28, 0.27, 0.27, 0.27, 0.26, 0.26, 0.26, 0.25, 0.25, 0.25
                ],
                borderColor: '#ff6384',
                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                tension: 0.4,
                borderWidth: 3,
                pointRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Training Loss Showing Plateau (Epochs 10-25)',
                    font: { size: 16 }
                },
                legend: {
                    display: true
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    title: {
                        display: true,
                        text: 'Loss',
                        font: { size: 14 }
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Epoch',
                        font: { size: 14 }
                    }
                }
            }
        }
    });

    // ReduceLR Chart
    const ctx2 = document.getElementById('reduceLRChart').getContext('2d');
    new Chart(ctx2, {
        type: 'line',
        data: {
            labels: Array.from({length: 50}, (_, i) => i + 1),
            datasets: [
                {
                    label: 'Training Loss',
                    data: [
                        0.7, 0.65, 0.58, 0.52, 0.45, 0.40, 0.37, 0.34, 0.32, 0.30,
                        0.30, 0.29, 0.27, 0.25, 0.22, 0.20, 0.18, 0.17, 0.16, 0.16,
                        0.16, 0.15, 0.14, 0.13, 0.12, 0.11, 0.11, 0.10, 0.10, 0.10,
                        0.10, 0.09, 0.08, 0.08, 0.07, 0.07, 0.06, 0.06, 0.06, 0.06,
                        0.06, 0.05, 0.05, 0.05, 0.04, 0.04, 0.04, 0.04, 0.04, 0.03
                    ],
                    borderColor: '#36a2eb',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    tension: 0.4,
                    borderWidth: 3,
                    pointRadius: 4,
                    yAxisID: 'y'
                },
                {
                    label: 'Learning Rate',
                    data: [
                        0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01,
                        0.005, 0.005, 0.005, 0.005, 0.005, 0.005, 0.005, 0.005, 0.005, 0.005,
                        0.0025, 0.0025, 0.0025, 0.0025, 0.0025, 0.0025, 0.0025, 0.0025, 0.0025, 0.0025,
                        0.00125, 0.00125, 0.00125, 0.00125, 0.00125, 0.00125, 0.00125, 0.00125, 0.00125, 0.00125,
                        0.000625, 0.000625, 0.000625, 0.000625, 0.000625, 0.000625, 0.000625, 0.000625, 0.000625, 0.000625
                    ],
                    borderColor: '#ffce56',
                    backgroundColor: 'rgba(255, 206, 86, 0.1)',
                    tension: 0,
                    borderWidth: 3,
                    pointRadius: 5,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'ReduceLROnPlateau in Action',
                    font: { size: 16 }
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Loss',
                        font: { size: 14 }
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Learning Rate',
                        font: { size: 14 }
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Epoch',
                        font: { size: 14 }
                    }
                }
            }
        }
    });
</script>
{% endblock %}